-- ==========================================================================================
-- 遗留数据清理脚本（一次性执行）
-- 文件: 0003_legacy_offline_cleanup.sql
-- 用途: 清理从旧版本升级到离线版时存在的外部网络引用
-- 执行时机: 
--   - 应用首次启动时自动执行（通过 Rust 的 migrations 机制）
--   - 仅执行一次，后续启动会跳过（由 app_migrations 表控制）
-- 业务背景:
--   - 本项目从纯前端网络版演进为离线桌面版
--   - 旧版本数据库中可能存储了外部 URL（头像、图标等）
--   - 这些外链在纯内网环境下会导致资源加载失败
--   - 本脚本将所有外链引用替换为本地离线资源
-- 
-- 清理目标:
--   1. 用户头像 URL（users.avatar 字段）
--   2. 路由菜单图标（routes.meta_icon 字段）
-- 
-- 重要说明:
--   - 本脚本具有幂等性，重复执行不会造成数据丢失
--   - 仅清理包含外链的记录，不影响本地数据
-- ==========================================================================================

-- ==========================================================================================
-- 清理用户头像外链
-- 说明:
--   - 将所有以 http://、https://、// 开头的头像 URL 清空
--   - 同时清理包含 "://" 的任意协议 URL
--   - 使用 TRIM 处理首尾空格，确保匹配准确
--   - 使用 LOWER 函数实现大小写不敏感匹配
-- 清理后效果:
--   - 头像字段变为空字符串，触发前端使用本地默认头像
--   - 用户无需重新设置头像，系统自动降级到本地资源
-- 
-- 匹配规则:
--   - 'http://%'     匹配 http 协议 URL
--   - 'https://%'    匹配 https 协议 URL
--   - '//%'          匹配协议相对 URL（//cdn.example.com/...）
--   - '://'          匹配任意协议的 URL（包含 ftp://、data:// 等）
-- ==========================================================================================
UPDATE users
SET avatar = ''  -- 清空头像，使用本地默认头像
WHERE TRIM(avatar) != ''  -- 只处理非空字段，避免误操作
  AND (
    LOWER(TRIM(avatar)) LIKE 'http://%'      -- http 协议
    OR LOWER(TRIM(avatar)) LIKE 'https://%'   -- https 协议
    OR LOWER(TRIM(avatar)) LIKE '//%'         -- 协议相对 URL
    OR INSTR(LOWER(TRIM(avatar)), '://') > 0  -- 任意协议 URL
  );

-- ==========================================================================================
-- 清理路由菜单图标外链
-- 说明:
--   - 将所有外链图标引用设置为 NULL（而非空字符串）
--   - 原因：routes 表的 meta_icon 字段允许 NULL
--   - 使用 INSTR 检测包含冒号的图标名称（Iconify 图标格式如 'ri:info'）
--   - Iconify 图标格式为 '前缀:图标名'，如 'ri/information-line'
-- 清理后效果:
--   - 菜单图标变为 NULL，前端菜单将不显示图标或使用默认图标
--   - 确保离线环境下菜单正常显示，无外链依赖
-- 
-- 匹配规则:
--   - INSTR(meta_icon, ':') > 0  匹配 Iconify 格式图标（ri:info）
--   - 'http://%'                   匹配 http 外链
--   - 'https://%'                  匹配 https 外链
--   - '//%'                        匹配协议相对 URL
--   - '://'                        匹配任意协议
-- 
-- 特别说明:
--   - Iconify 图标格式包含冒号（如 'ep:avatar'、'ri:user'）
--   - 这些图标在纯前端网络版可用，但需要 Iconify CDN 支持
--   - 离线环境下应使用本地图标或移除图标显示
-- ==========================================================================================
UPDATE routes
SET meta_icon = NULL  -- 设置为 NULL，移除外链图标
WHERE meta_icon IS NOT NULL  -- 只处理非空字段
  AND TRIM(meta_icon) != ''  -- 只处理非空字符串
  AND (
    INSTR(meta_icon, ':') > 0                       -- Iconify 格式图标（如 'ri:info'）
    OR LOWER(TRIM(meta_icon)) LIKE 'http://%'       -- http 外链
    OR LOWER(TRIM(meta_icon)) LIKE 'https://%'     -- https 外链
    OR LOWER(TRIM(meta_icon)) LIKE '//%'            -- 协议相对 URL
    OR INSTR(LOWER(TRIM(meta_icon)), '://') > 0     -- 任意协议 URL
  );

-- ==========================================================================================
-- 执行效果总结
-- ==========================================================================================
-- 本脚本执行后:
--   1. 所有用户的外链头像 URL 变为空字符串 → 前端使用本地默认头像
--   2. 所有路由的外链/Iconify 图标变为 NULL → 菜单不显示图标或使用默认
-- 
-- 兼容性说明:
--   - 本脚本仅影响包含外链的记录
--   - 原本就使用本地资源（空值、本地图标）的记录不受影响
--   - 首次启动后，所有数据都是离线安全的
-- ==========================================================================================
